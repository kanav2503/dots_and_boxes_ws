# Dots & Boxes — Flutter + Dart Engine + Firebase RTDB + Interpretable AI

A cross‑platform **Dots & Boxes** app with a pure Dart rules engine, real‑time online play via **Firebase Realtime Database**, and simple, **interpretable AI** agents. Runs on Android and Web from a single codebase. Includes an evaluation harness to reproduce AI‑vs‑AI results.

> Stack: **Flutter/Dart**, **Firebase RTDB** (+ anonymous auth), and a small **game_engine** package (pure Dart).

---

## Quick start

### Prereqs
- Flutter 3.x (with Dart SDK)
- A Firebase project + **FlutterFire CLI** (`dart pub global activate flutterfire_cli`)
- Enable **Anonymous Auth** and **Realtime Database** in your Firebase console

### Setup
```bash
# 1) Install deps
flutter pub get

# 2) Generate firebase_options.dart for your project
flutterfire configure

# 3) Run on web or Android
flutter run -d chrome
# OR
flutter run -d android
```

> The file `lib/firebase_options.dart` is generated by FlutterFire. API keys here are **not secrets** by design, but your RTDB **security rules** must still protect data.

---

## How to play

### Local (Hot‑seat)
1. Pick a **grid size** (e.g., 4×4, 6×6).
2. Choose **2–4 players**, enter names.
3. Tap edges to play; completing a box gives you **the box and an extra turn**.

### Vs AI
- **Random** – picks any legal edge.
- **Heuristic** – avoids moves that hand the opponent an immediate box.
- **Deep (2‑ply)** – scores “my gain − opponent’s best immediate gain”; in the app we also demo a *double‑cross‑aware* variant that penalises replies worth 2+ boxes.

### Online
1. Create a room (host) and share the **Room ID**.
2. Guest enters the Room ID and joins.
3. The app writes tiny move records to RTDB under `rooms/<roomId>/moves`. Everyone replays the same stream with the same engine, so boards stay identical.

---

## Project structure

```
.
├─ lib/
│  ├─ main.dart
│  ├─ home_page.dart
│  ├─ online_lobby_page.dart
│  ├─ waiting_room_page.dart
│  ├─ widgets/
│  │  └─ game_board.dart
│  └─ firebase_options.dart        # generated by FlutterFire
├─ packages/
│  └─ game_engine/
│     ├─ lib/src/
│     │  ├─ game.dart             # pure engine, deterministic
│     │  └─ ai.dart               # Random / Heuristic1 / Deep2
│     ├─ test/                    # unit tests (dart test)
│     └─ bin/
│        └─ benchmark_experiments.dart  # AI vs AI batch runner
└─ .gitignore (ignores eval output dirs under bin/)
```

---

## Architecture (high level)

- **Engine (Dart)** — single source of truth: state transitions, scoring, turn logic. Pure & deterministic.
- **Flutter UI** — renders board, turns taps into edge coordinates (`x1,y1,x2,y2`).
- **Match orchestrator** — calls `game.playEdge(...)`, updates UI.
- **RTDB move bus** — online mode appends `{edge, playerIndex}` to `rooms/<roomId>/moves`. All clients **replay** the same moves using the same engine call, so everyone converges to the same state.

**Turn control:** `playerIndex` in the event represents **who just moved**. The **engine** decides who moves next (extra‑turn rule) when each client calls `playEdge(...)` on receipt.

---

## Evaluation & reproduction

Run batch experiments (AI vs AI) across grid sizes:

```bash
cd packages/game_engine
dart run bin/benchmark_experiments.dart
```

Outputs two CSVs in the working dir:
- `benchmark2_summary.csv` — pairing‑level aggregates (win rate, unsafe moves, turns, streaks, timing p50/p95)
- `benchmark2_games.csv` — per‑game metrics with per‑move timing summaries

By default, the repo ignores these local folders (keep them on your machine, not on GitHub):
```
packages/game_engine/bin/evaluation/
packages/game_engine/bin/figs_eval2/
```

> Tip: add plots/notebooks under `packages/game_engine/bin/figs_eval2` if you want to recreate figures from the dissertation.

---

## Tests

Engine unit tests:
```bash
cd packages/game_engine
dart test
```

---

## Firebase security (example rules)

Start strict, then relax as needed for development:

```json
{
  "rules": {
    ".read": false,
    ".write": false,
    "rooms": {
      "$roomId": {
        ".read": "auth != null",
        ".write": "auth != null",
        "players": { ".read": "auth != null", ".write": "auth != null" },
        "moves":   { ".read": "auth != null", ".write": "auth != null" }
      }
    }
  }
}
```

**Harden for production:** restrict writes so only room members can write to their room, and only on their turn. The app already enforces this on the client; rules should mirror it server‑side.

---

## Performance (observed on 6×6)

- Engine medians **< 4 ms** per move; **p95 ~22 ms** (pure engine timing).
- RTDB propagation typically **sub‑second** on normal networks.

This is comfortable for real‑time UX. Turns are discrete, so tails are rarely visible to users.

---

## Roadmap

- Explicit **chain** and **parity** detection in the engine.
- Larger boards (7×7–10×10) with **pruning** and better move ordering.
- **Human‑vs‑AI** studies and parameter ablations.
- Online UX polish: reconnection UX, basic anti‑cheat, spectator mode.

---

## License

MIT License

Copyright (c) 2025 Kanav Malhotra

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

---

## Acknowledgements

Dots & Boxes is a classic pencil‑and‑paper game; thanks to the community for the many strategy write‑ups that inspired the heuristics. Flutter, Firebase, and Dart make the cross‑platform angle straightforward.
